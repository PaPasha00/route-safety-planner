import axios from 'axios';
import { RouteAnalysisRequest, RouteGeometryAnalysis, GeographicContext, DailyRoute, DailyWeather } from '../types';

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –ò–ò
 */
export function generateAnalysisPrompt(
  request: RouteAnalysisRequest,
  terrainType: string,
  geographicContext: GeographicContext,
  formattedGeoContext: string,
  routeAnalysis: RouteGeometryAnalysis
): string {
  const startDate = new Date(request.startDate);
  const endDate = new Date(request.endDate);
  const totalDays = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

  return `
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –º–∞—Ä—à—Ä—É—Ç –∏ –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –æ—Ü–µ–Ω–∫—É —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:

–ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –ö–û–ù–¢–ï–ö–°–¢:
${formattedGeoContext}
${geographicContext.multiRegion ? '–ú–ê–†–®–†–£–¢ –ü–†–û–•–û–î–ò–¢ –ß–ï–†–ï–ó –ù–ï–°–ö–û–õ–¨–ö–û –†–ï–ì–ò–û–ù–û–í - –£–ß–¢–ò –≠–¢–û –ü–†–ò –ê–ù–ê–õ–ò–ó–ï!' : ''}
${geographicContext.multiCountry ? '–ú–ê–†–®–†–£–¢ –ü–†–û–•–û–î–ò–¢ –ß–ï–†–ï–ó –ù–ï–°–ö–û–õ–¨–ö–û –°–¢–†–ê–ù - –û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï –ù–ê –ì–†–ê–ù–ò–¶–´ –ò –†–ê–ó–õ–ò–ß–ò–Ø –í –ò–ù–§–†–ê–°–¢–†–£–ö–¢–£–†–ï!' : ''}

–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–ê–†–ê–ú–ï–¢–†–´ –ú–ê–†–®–†–£–¢–ê:
- –ü—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç—å: ${request.lengthKm} –∫–º
- –û–±—â–∏–π –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã: ${request.elevationGain} –º–µ—Ç—Ä–æ–≤
- –¢–∏–ø –º–µ—Å—Ç–Ω–æ—Å—Ç–∏: ${terrainType} (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Ä–µ–ª—å–µ—Ñ—É)
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞: ${request.coordinates.length}
- –¢–∏–ø —Ç—É—Ä–∏–∑–º–∞: ${request.tourismType}
- –î–∞—Ç—ã –ø–æ—Ö–æ–¥–∞: ${request.startDate} - ${request.endDate} (${totalDays} –¥–Ω–µ–π)

–ê–ù–ê–õ–ò–ó –†–ï–õ–¨–ï–§–ê:
- –°—Ä–µ–¥–Ω–∏–π —É–∫–ª–æ–Ω: ${routeAnalysis.avgSlope.toFixed(1)}%
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É–∫–ª–æ–Ω: ${routeAnalysis.maxSlope.toFixed(1)}%
- –ö—Ä—É—Ç—ã—Ö –ø–æ–¥—ä–µ–º–æ–≤ (>15%): ${routeAnalysis.steepSections} —É—á–∞—Å—Ç–∫–æ–≤
- –û–±—â–∞—è –∏–∑–≤–∏–ª–∏—Å—Ç–æ—Å—Ç—å: ${routeAnalysis.sinuosity.toFixed(2)}
- –í—ã—Å–æ—Ç–∞ –Ω–∞–¥ —É—Ä–æ–≤–Ω–µ–º –º–æ—Ä—è: –æ—Ç ${routeAnalysis.minElevation}–º –¥–æ ${routeAnalysis.maxElevation}–º
- –ü–µ—Ä–µ–ø–∞–¥ –≤—ã—Å–æ—Ç: ${routeAnalysis.maxElevation - routeAnalysis.minElevation}–º

–î–ê–ù–ù–´–ï –û –í–´–°–û–¢–ê–• (–ø–µ—Ä–≤—ã–µ 10 —Ç–æ—á–µ–∫ –∏–∑ ${request.elevationData.length}):
${request.elevationData.slice(0, 10).map((elev, i) => `  ${i+1}. ${elev}–º`).join('\n')}

–ü–†–û–§–ò–õ–¨ –ú–ê–†–®–†–£–¢–ê: ${routeAnalysis.elevationProfile}

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç –∏ –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —É—á–∏—Ç—ã–≤–∞—è —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –º–æ–∂–µ—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ —Ä–∞–∑–Ω—ã–µ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã:

1. –ì–ï–û–ì–†–ê–§–ò–ß–ï–°–ö–ê–Ø –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ê
- –û–ø–∏—à–∏ –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã/—Å—Ç—Ä–∞–Ω—ã —á–µ—Ä–µ–∑ –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–∞—Ä—à—Ä—É—Ç
- –•–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–ª—å–µ—Ñ–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
- –ö–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞

2. –û–ë–©–ê–Ø –û–¶–ï–ù–ö–ê –°–õ–û–ñ–ù–û–°–¢–ò (–ø–æ —à–∫–∞–ª–µ 1-10)
- –û–±–æ—Å–Ω—É–π –æ—Ü–µ–Ω–∫—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∞
- –£–∫–∞–∂–∏ —Ä–∞–∑–ª–∏—á–∏—è –≤ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö
- –°—Ä–∞–≤–Ω–∏ —Å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–º–∏ –º–∞—Ä—à—Ä—É—Ç–∞–º–∏ –≤ —ç—Ç–∏—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö

3. –¢–ò–ü –ú–ê–†–®–†–£–¢–ê –ò –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
- –î–ª—è –∫–∞–∫–∏—Ö –≤–∏–¥–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—Ç —Ä–∞–∑–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–µ–∑–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
- –û–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—Ç—è–∂–µ–Ω–Ω–æ—Å—Ç–∏

4. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –û–°–û–ë–ï–ù–ù–û–°–¢–ò
- –ê–Ω–∞–ª–∏–∑ –∫–ª—é—á–µ–≤—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞—Ö
- –û—Ü–µ–Ω–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ (–æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤)
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞

5. –≠–ö–ò–ü–ò–†–û–í–ö–ê –ò –ü–û–î–ì–û–¢–û–í–ö–ê
- –ù–µ–æ–±—Ö–æ–¥–∏–º–æ–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
- –¢—Ä–µ–±—É–µ–º—ã–π —É—Ä–æ–≤–µ–Ω—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–ª—è –º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–∏ —Ä–µ–≥–∏–æ–Ω–æ–≤

6. –ü–û–¢–ï–ù–¶–ò–ê–õ–¨–ù–´–ï –†–ò–°–ö–ò –ò –û–°–û–ë–ï–ù–ù–û–°–¢–ò
- –û–ø–∞—Å–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–µ (—É—á–∏—Ç—ã–≤–∞—è —Ä–∞–∑–Ω—ã–µ —Ä–µ–≥–∏–æ–Ω—ã)
- –ú–µ—Ç–µ–æ—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
- –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –º–µ—Å—Ç–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –ª–æ–≥–∏—Å—Ç–∏–∫–∏

7. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò
- –°–æ–≤–µ—Ç—ã –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –º–Ω–æ–≥–æ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∞–∫–∫–ª–∏–º–∞—Ç–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–ø–∞–¥—ã –≤—ã—Å–æ—Ç)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ, –Ω–æ—á–ª–µ–≥–µ, –≤–æ–¥–µ –≤–¥–æ–ª—å –º–∞—Ä—à—Ä—É—Ç–∞

8. –†–ê–ó–ë–ò–í–ö–ê –ü–û –î–ù–Ø–ú
- –ü—Ä–µ–¥–ª–æ–∂–∏ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –Ω–∞ ${totalDays} –¥–Ω–µ–π
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è —É–∫–∞–∂–∏: —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ, –Ω–∞–±–æ—Ä –≤—ã—Å–æ—Ç—ã, –∫–ª—é—á–µ–≤—ã–µ —Ç–æ—á–∫–∏
- –£—á—Ç–∏ —Ç–∏–ø —Ç—É—Ä–∏–∑–º–∞ (${request.tourismType}) –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –¥–Ω–µ–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤

9. –ü–†–û–ì–ù–û–ó –ü–û–ì–û–î–´
- –û—Ü–µ–Ω–∏—Ç–µ –ø–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –ø–æ—Ö–æ–¥–∞
- –£—á—Ç–∏—Ç–µ —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å –∏ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ
- –î–∞–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —ç–∫–∏–ø–∏—Ä–æ–≤–∫–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è

–û–°–û–ë–û–ï –í–ù–ò–ú–ê–ù–ò–ï: –º–∞—Ä—à—Ä—É—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ ${geographicContext.multiRegion ? '–Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–≥–∏–æ–Ω–æ–≤' : '–æ–¥–∏–Ω —Ä–µ–≥–∏–æ–Ω'} - —É—á—Ç–∏ —ç—Ç–æ –≤ –∞–Ω–∞–ª–∏–∑–µ!
–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–º, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤.
  `;
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –ò–ò –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–∞—Ä—à—Ä—É—Ç–∞
 */
export async function analyzeRouteWithAI(prompt: string): Promise<string> {
  try {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ API –∫–ª—é—á–∞
    if (!process.env.OPENROUTER_API_KEY) {
      throw new Error('OPENROUTER_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º API –∫–ª—é—á–æ–º');
    }
    
    console.log('ü§ñ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ò–ò —Å –∞–Ω–∞–ª–∏–∑–æ–º –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞...');
    
    const response = await axios.post(
      'https://openrouter.ai/api/v1/chat/completions',
      {
        model: 'deepseek/deepseek-chat',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 2500,
        temperature: 0.7
      },
      {
        headers: {
          'Authorization': `Bearer ${process.env.OPENROUTER_API_KEY}`,
          'HTTP-Referer': 'http://localhost:5173',
          'X-Title': 'Route Safety Planner'
        }
      }
    );

    const analysis = response.data.choices[0].message.content.trim();
    console.log('‚úÖ –ê–Ω–∞–ª–∏–∑ –æ—Ç –ò–ò –ø–æ–ª—É—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
    
    return analysis;
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò:', (error as Error).message);
    
    // –ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ —Å API –∫–ª—é—á–æ–º, –¥–∞–µ–º –±–æ–ª–µ–µ –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if ((error as any).response?.status === 401) {
      throw new Error('API –∫–ª—é—á OpenRouter –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π. –°–º. API_SETUP.md –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
    }
    
    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –æ—Ç –ò–ò');
  }
}
